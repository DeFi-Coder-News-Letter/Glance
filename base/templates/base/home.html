{% extends "_layouts/base.html" %}

{% block css %}
{{block.super}}
<style>
/* Move down content because we have a fixed navbar that is 50px tall */
body {
  padding-top: 0px;
  padding-bottom: 20px;
}
</style>
{% endblock css %}

{% block page_title %}Glance{% endblock %}
{% block page_class %}home-page{% endblock %}
{% block content %}


<!-- Docs page layout -->
    <div class="bs-docs-header" id="content">
      <div class="container">
        <h1><a href="http://glance.wtf">Glance</a></h1>
        <p>Good reads, extremely fucking fast.</p>

      </div>
    </div>

    <div class="container bs-docs-container">

      <div class="row">
<div class="col-md-9" role="glanceer">


<link href='https://rawgithub.com/Miserlou/Glance/master/style.css' rel='stylesheet' type='text/css'>        

</div><!-- end glanceer -->

<div class="col-md-9" role="main">

<div class="row hidden-md hidden-lg">
<ul class="nav nav-pills">
  <li><a href="#js-mostread">Most Read</a></li>
  <li><a href="#js-recent">Recent</a></li>
  <li><a href="#js-news">News</a></li>
  <li><a href="#js-commentary">Commentary</a></li>
  <li><a href="#js-fiction">Fiction</a></li>
  <li><a href="#js-classics">Classics</a></li>
  <li><a href="#js-hn">HN</a></li>
  <li><a href="#js-truereddit">TrueReddit</a></li>
  <li><a onclick="toggleLights(); return false;">Toggle Lights</a></li>
</ul>
<br />
</div>

<div class="bs-docs-section">
  <h1 id="js-mostread" class="page-header">Most Read</h1>
  <div id="mostread">

  </div>

</div>

<div class="bs-docs-section">
  <h1 id="js-recent" class="page-header">Recent</h1>
  <div id="recent">

  </div>


</div>

<div class="bs-docs-section">
  <h1 id="js-news" class="page-header">News <small>mostly bad</small></h1>
  <div id="news">

  </div>

</div>

<div class="bs-docs-section">
  <h1 id="js-commentary" class="page-header">Commentary <small>talking heads</small></h1>

  <div id="commentary">

  </div>

</div>

<div class="bs-docs-section">
  <h1 id="js-fiction" class="page-header">Fiction <small>suggestions welcome</small></h1>

  <div id="fiction">

  </div>

</div>

<div class="bs-docs-section">
  <h1 id="js-classics" class="page-header">Classics <small>coming soon!</small></h1>
  <div id="classics">

  </div>

</div>

<div class="bs-docs-section">
  <h1 id="js-hn" class="page-header">HN <small>rich nerd yack</small></h1>

  <div id="hn">

  </div>

</div>

<div class="bs-docs-section">
  <h1 id="js-truereddit" class="page-header">TrueReddit <small><i>"Sometimes broken!™"</i></small></h1>

  <div id="truereddit">

  </div>

</div>


</div>

        <div class="col-md-3">
          <div class="bs-docs-sidebar hidden-print hidden-xs hidden-sm" role="complementary">
            <ul class="nav bs-docs-sidenav">

<li>
  <a href="#js-mostread">Most Read</a>
  <ul class="nav">

  </ul>
</li>
<li>
  <a href="#js-recent">Recent</a>
  <ul class="nav">
  </ul>
</li>
<li>
  <a href="#js-news">News</a>

  <ul class="nav">

  </ul>
</li>
<li>
  <a href="#js-commentary">Commentary</a>
  <ul class="nav">

  </ul>
</li>
<li>
  <a href="#js-fiction">Fiction</a>
  <ul class="nav">

  </ul>
</li>
<li>
  <a href="#js-classics">Classics</a>
  <ul class="nav">

  </ul>
</li>
<li>
  <a href="#js-hn">HN</a>
  <ul class="nav">

  </ul>
</li>
<li>
  <a href="#js-truereddit">TrueReddit</a>
  <ul class="nav">

  </ul>
</li>
            </ul>

            <a class="back-to-top" href="#footer">
              About
            </a>

            <a class="back-to-top" href="#top">
              Back to top
            </a>

            <a class="back-to-top" onclick="toggleLights(); return false;" href="#">
              Toggle Lights
            </a>

            <br />

            <p class="back-to-top">

            <select id="glance_selector" class="form-control">
              <option value="200">200wpm</option>
              <option value="300">300wpm</option>
              <option value="350">350wpm</option>
              <option value="400">400wpm</option>
              <option value="450">450wpm</option>
              <option value="500">500wpm</option>
              <option value="550">550wpm</option>
              <option value="600">600wpm</option>
              <option value="650">650wpm</option>
              <option value="700" selected>700wpm</option>
              <option value="750">750wpm</option>
              <option value="800">800wpm</option>
              <option value="850">850wpm</option>
              <option value="900">900wpm</option>
              <option value="950">950wpm</option>
            </select>

            <button type="button" id="glance_toggle" class="hide">Pause</button>

          </p>


          </div>
        </div>
      </div>
    </div>

<style>

.glance_result{

}

.glance_holder{
    font-family: 'Droid Sans Mono', sans-serif;
    width: 100%;
}

.glance_spacer{
    width: 100%;
    /* 600px+; small tablet portrait */
    min-height: 210px;
}

.glance_container{
    /* 600px+; small tablet portrait */
    width: 420px;
    margin-left: auto;
    margin-right: auto;
    line-height: 36px;
}

.glance_result{
    text-align: left;
    font-family: 'Droid Sans Mono', sans-serif;
    /* 600px+; small tablet portrait */
    font-size: 32px;
}

#glance_credits{
    float: right;
    font-family: 'Droid Sans Mono', sans-serif;
    /* 600px+; small tablet portrait */
    font-size: 13px;
}

#glance_credits a{
    color: #dddddd;
    text-decoration: none;
}

#glance_selector, #glance_toggle{
    width: auto;
}

.invisible{
    font-family: 'Droid Sans Mono', sans-serif;
    color: #ffffff;
    position: static;
}

.start, .pivot, .end, .glance_start, .glance_pivot, .glance_end{
    font-family: 'Droid Sans Mono', sans-serif;
    /* 600px+; small tablet portrait */
    font-size: 32px;
    pointer-events: none;
}

.pivot, .glance_pivot{
    color: #de0000;
}

.glance_main{
  padding-top: 10px;
  padding-bottom: 0px;
}

@media (max-width: 599px) {

    h1{
      font-size: 32px;
    }

    .glance_holder{
        width: 320px;
        padding-top: 4px;
        padding-bottom: 6px;
        margin-bottom: 6px;
        min-height: 70px;
    }

    #glance_spacer{
        min-height: 105px;
    }

    .glance_container{
        width: 320px;
        margin-left: auto;
        margin-right: auto;
        line-height: 22px;
    }

    .glance_result{
        min-height: 22px;
        font-size: 28px;
        padding-top: 24px;
        padding-bottom: 24px;
    }

    .guide_top, .guide_bottom{
        font-size: 28px;
    }

    .notch{
        font-size: 12px;
    }

    #glance_credits{
        font-size: 10px;
    }

    .start, .pivot, .end, .glance_start, .glance_pivot, .glance_end{
        font-size: 28px;
    }

}

.label-counter{
  background-color: none;
  color: #de0000;
}

</style>

{% verbatim %}
<script id="link-template" type="text/x-handlebars-template">

<div id="{{id}}">
    <div class="page-header">
      <h3 id="link-{{id}}" class="articletitle">{{#if reads}}<span class="label label-counter">{{reads}}</span>&nbsp;{{/if}}<a href="#" onclick="glanceifyURL('{{url}}'); return false;">{{title}}</a></h3>
    <p style="max-width: 100%; word-wrap:break-word;">
      <i class="text-muted">{{url}}</i>
    </p>
    </div>
</div>

<div id="glance_result-{{id}}-holder"  style="display: none;">

<div class="glance_result">

<div class="glance_holder">

            <div class="guide_top">
<span>...</span><span class="notch">▼</span>
            </div>

<div id="glance_result-{{id}}" class="glance_main">
Loading..
</div>

            <div class="guide_top">
<span>...</span><span class="notch">▲</span>
            </div>

</div>
</div>

<div>


<div class="page-header" style="margin-top: 9px;">
  <p style="max-width: 100%; word-wrap:break-word;">
    <b class="minititle" onclick="glanceifyURL('{{url}}'); return false;">{{title}}</b><br />
    <i class="text-muted">{{url}}</i>
  </p>
</div>

</div>

</div>

</script>

{% endverbatim %}


{% endblock %}

{% block post_scripts %}
<script type="text/javascript">

    function createOrUpdate(url, title){
      var Article = Parse.Object.extend("Article");
      var query = new Parse.Query(Article);
      query.equalTo("url", url);
      query.equalTo("title", title);
      query.find({
        success: function(results) {

            // Don't have the object, create it.
            if(results.length < 1){
               var article = new Article();
               article.set("url", url);
               article.set("title", title);
               article.set("reads", 1);
               article.save();
               return;
            } else {
               // Update object if we already have it.
               var article = results[0];
               article.increment("reads");
               article.save();d
               return;
            }
        },
        error: function(error) {
        }
      });
    }

  $(document).ready(function(){

    Parse.initialize("IKXOwtsEGwpJxjD56rloizwwsB4pijEve8nU5wkB", "90J0CYICpTBqvhCmqrQvBTo3XGjyWB5fv0FEHU1W");
    var Article = Parse.Object.extend("Article");
    var link_template_source   = $("#link-template").html();
    var template = Handlebars.compile(link_template_source);

    // Parse feeds
    var query = new Parse.Query(Article);
    query.descending("reads");
    query.limit(25);
    var d = new Date();
    d.setDate(d.getDate() - 2);
    query.greaterThan("createdAt", d);
    query.find({
      success: function(results) {
        // Do something with the returned Parse.Object values
        for (var i = 0; i < results.length; i++) {
          var object = results[i];

          var id = convertToSlug(object.get('url'));

          var me = {url: object.get('url'), title: object.get('title'), reads: object.get('reads'), id: id};
          var html    = template(me);
          $('#mostread').append(html);
        }
      },
      error: function(error) {
        console.log("Error: " + error.code + " " + error.message);
      }
    });

    var recent_query = new Parse.Query(Article);
    recent_query.descending("createdAt");
    recent_query.limit(25);
    recent_query.find({
      success: function(results) {
        // Do something with the returned Parse.Object values
        for (var i = 0; i < results.length; i++) {
          var object = results[i];

          var id = convertToSlug(object.get('url'));

          var me = {url: object.get('url') + '#glancerecent', title: object.get('title'), reads: object.get('reads'), id: id + 'glancerecent'};
          var html    = template(me);
          $('#recent').append(html);
        }
      },
      error: function(error) {
        console.log("Error: " + error.code + " " + error.message);
      }
    });

    // Y!Pipes feeds
    YUI({ filter:'raw' }).use("io-xdr", "json-parse", "node",
        function(Y) {

            //Event handler called when the transaction begins:
            var handleStart = function(id, a) {
            }

            //Event handler for the success event -- use this handler to write the fetched
            //RSS items to the page.
            var handleSuccess = function(id, o, a) {

                //We use JSON.parse to sanitize the JSON (as opposed to simply performing an
                //JavaScript eval of the data):
                var oRSS = Y.JSON.parse(o.responseText);

                //From here, we simply access the JSON data from where it's provided
                //in the Yahoo! Pipes output:
                if (oRSS && oRSS.count) {

                    for (var i=0; i<oRSS.count; i++) {
                        var id = convertToSlug(oRSS.value.items[i]['link']);
                        var me = {url: oRSS.value.items[i]['link'], title: oRSS.value.items[i]['title'], id: id};
                        var html    = template(me);
                        $('#' + a['feedtype']).append(html);
                    }
                } else {
                }

                var $body   = $(document.body)
                $body.scrollspy('refresh');
            }

            //In the event that the HTTP status returned does not resolve to,
            //HTTP 2xx, a failure is reported and this function is called:
            var handleFailure = function(id, o, a) {
                Y.log("ERROR " + id + " " + a, "info", "example");
            }

            //With all the apparatus in place, we can now configure our
            //IO call.  The method property is defined, but if omitted,
            //IO will default to HTTP GET.


            var loadPipe = function(pipe, type) {

              var cfg = {
                  method: "GET",
                  arguments: {feedtype: type},
                  xdr: {
                      use:'native'
                  },
                  on: {
                      //Our event handlers previously defined:
                      start: handleStart,
                      success: handleSuccess,
                      failure: handleFailure
                  }
              };

                var obj = Y.io(
                    //this is a specific Pipes feed, populated with cycling news:
                    pipe,
                    cfg
                );
            }

            loadPipe("http://pipes.yahoo.com/pipes/pipe.run?_id=40805955111ac2e85631facfb362f067&_render=json", "news");
            loadPipe("http://pipes.yahoo.com/pipes/pipe.run?_id=dc1a399c275cbc0bcf6329c8419d6f4f&_render=json", "commentary");
            loadPipe("http://pipes.yahoo.com/pipes/pipe.run?_id=ee8d2db2513114660b054cd82da29b69&_render=json", "fiction");
            loadPipe("http://pipes.yahoo.com/pipes/pipe.run?_id=af38f38c0a21785ef8409d48ab4c1246&_render=json", "hn");
            loadPipe("http://pipes.yahoo.com/pipes/pipe.run?_id=792a6a5fc2c23eafe6a80855263ac259&_render=json", "truereddit");
        }
    );

});

function convertToSlug(Text)
{
    return Text
        .toLowerCase()
        .replace(/[^\w ]+/g,'')
        .replace(/ +/g,'-')
        ;
}
</script>

<script>

var lightsOn = true;
$(document).ready(function(){
  lightsOn = JSON.parse(localStorage.getItem('lightsOn'));
  if (lightsOn === false){
    lightsOn = true;
    toggleLights();
  }
  var wpm = localStorage.getItem('WPM');
  if(wpm != null){
    $("#glance_selector option").filter(function() {
        return $(this).text() == wpm + 'wpm'; 
    }).prop('selected', true);
  }

});

function toggleLights(){

  if(lightsOn){
    $('#lightsTheme').attr('href', "{{STATIC_URL}}/css/darkTheme.css");
    lightsOn = false;
    localStorage.setItem('lightsOn', "false");
  } else{
    $('#lightsTheme').attr('href', "{{STATIC_URL}}/css/lightTheme.css");
    lightsOn = true;
    localStorage.setItem('lightsOn', "true");
  }
}

</script>

{% endblock %}